# データベース変更履歴

## 2025-05-03 - データベース履歴のリセット
- 過去のデータベース変更履歴を一掃し、新たな履歴管理を開始
- 変更内容：
  - 不要なテーブル（admin_users, chat_rooms, chat_room_members, chat_messages, message_read_status）の削除
  - 過去の変更履歴をバックアップディレクトリに移動（`/bkup/changes.md.bak`）
  - 不要なSQLスクリプトディレクトリをバックアップディレクトリに移動（`/bkup/sql_scripts_chat`）
- 現在のテーブル：
  - user_profiles: ユーザー情報管理テーブル（ロール、プラン、プロフィール情報等）

## 2025-05-04 - メモ機能のためのテーブル追加
- 変更内容：
  - notesテーブルを追加
  - メモの作成、参照、更新、削除のためのRLSポリシーを設定
  - 公開メモの参照ポリシーを追加
  - 管理者がすべてのメモにアクセスできるポリシーを追加
- 関連スクリプト：
  - `/sql/scripts/notes_table.sql` - メモテーブル作成スクリプト
  - `/sql/scripts/notes_table_rollback.sql` - ロールバック用スクリプト

## 2025-05-04 - タグ機能のためのテーブル追加
- 変更内容：
  - tagsテーブルを追加：ユーザーごとのタグを管理
  - note_tagsテーブルを追加：メモとタグの関連付けを管理
  - 各テーブルのRLSポリシーを設定：
    - ユーザーは自分のタグのみ作成・編集・削除可能
    - 公開メモのタグ情報は誰でも参照可能
    - ユーザーは自分のメモに対してのみタグを関連付け可能
    - 管理者はすべてのタグ情報にアクセス可能
- 関連スクリプト：
  - `/sql/scripts/tags/tags_tables.sql` - タグ関連テーブル作成スクリプト
  - `/sql/scripts/tags/tags_tables_rollback.sql` - ロールバック用スクリプト

## 2025-05-05 - メモ画像添付機能のためのテーブル追加
- 変更内容：
  - note_imagesテーブルを追加：メモに添付される画像のメタデータを管理
  - 画像の基本情報（ファイル名、サイズ、MIME型など）と関連メモを紐付け
  - 画像の解像度（幅・高さ）情報を保存
  - 各メモ画像に対するRLSポリシーを設定：
    - ユーザーは自分のメモの画像のみ作成・編集・削除可能
    - 公開メモの画像は誰でも参照可能
    - 管理者はすべてのメモ画像にアクセス可能
  - Supabaseストレージバケット「note_images」を作成し、RLSポリシーを設定
- 関連スクリプト：
  - `/sql/scripts/storage/note_images_setup.sql` - メモ画像テーブル作成スクリプト
  - `/sql/scripts/storage/note_images_rollback.sql` - ロールバック用スクリプト

## 今後の方針
- データベース変更時には本ファイルに変更内容を記録する
- schema.sqlファイルを常に最新の状態に保つ
- 重要なSQLスクリプトは別途保存するが、適用済みのスクリプトはバックアップに移動する
